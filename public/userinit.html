<!DOCTYPE html>
<html>
<head>
  <!-- Bootstrap の css をインポートする。参考 https://getbootstrap.jp/docs/4.5/getting-started/introduction/　-->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

  <!-- モバイルブラウザでのレイアウトを制御する。参考 https://qiita.com/ryounagaoka/items/045b2808a5ed43f96607 -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

  <!-- 検索エンジンに引っかからないようにする。参考 https://ameblo.jp/masa30201/entry-11564231810.html -->
  <meta name="Keywords" content="norobot">

  <!--  -->
  <script defer src="https://www.gstatic.com/firebasejs/6.2.0/firebase-app.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/6.2.0/firebase-database.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/6.2.0/firebase-firestore.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/6.2.0/firebase-auth.js"></script>

  <script defer src="/__/firebase/init.js"></script>
  <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase.js"></script>
  <script src="/config.js"></script>
  <!-- jQuery, Bootstrap の JSライブラリ をロードする。参考 https://getbootstrap.jp/docs/4.5/getting-started/introduction/ -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

  <!-- android のブラウザを全画面表示にさせる -->
  <meta name="mobile-web-app-capable" content="yes">

  <!-- iOS のブラウザを全画面表示にさせる -->
  <meta name="apple-mobile-web-app-capable" content="yes">

  <title>TORIMOTSU USER SETTING</title>

  <!-- CSS の定義 -->
  <style>
      
    /* ボタンの書式*/
   .btn{
       background:#deb887;
       color:#808080;
       font:"游ゴシック";
     
     
   }
   
   /* 書式*/
   .settei{
       margin:5px 30px 0px 30px;
       color:#A59d9d;
       font:"游ゴシック";
       
       }
/*icon*/

.button_icon{
    width:14%;

}

.navbar{
    background-color:#deb887;
}


body{
    background-color:#ffe8d1;
}

/*  文字の色を指定 */
.fontBlue {
 color: blue;
}
.fontRed {
 color: red;
}
</style>
  <script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>
<link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.css" />
</head>
<body>
<!-- ナビゲーションバーの配置。参考https://getbootstrap.jp/docs/4.5/components/navbar/ -->
<nav class="navbar">
       
  <span >
  
      
 <img src="picture/haguruma.png" class="button_icon" id="id_change">
 <img src="picture/logout.png" class="button_icon" id="logout">
</span>
</nav>
 
<div class="settei">
  <h3>個人情報設定</h3>
<!--個人情報フォーム-->
<form>
<div class="form-row">
<label class="col-sm-3 col-form-label">お名前
</label>
<div class="col-sm-9">
<p>
<input type="text" id="name" autocomplete="name" class="form-control" placeholder="お名前">
</p>
</div>
</div>

<div class="form-row">
<label class="col-sm-3 col-form-label">生年月日</label>
​
<div class="col-sm-9">
​
<select class="custom-select w-25" title="生年月日(西暦)" id="bday-year" autocomplete="bday-year">
<option selected="">----</option>
<option value="2010">2010</option>
<option value="2009">2009</option>
<option value="2008">2008</option>
<option value="2007">2007</option>
<option value="2006">2006</option>
<option value="2005">2005</option>
<option value="2004">2004</option>
<option value="2003">2003</option>
<option value="2002">2002</option>
<option value="2001">2001</option>
<option value="2000">2000</option>
<option value="1999">1999</option>
<option value="1998">1998</option>
<option value="1997">1997</option>
<option value="1996">1996</option>
<option value="1995">1995</option>
<option value="1994">1994</option>
<option value="1993">1993</option>
<option value="1992">1992</option>
<option value="1991">1991</option>
<option value="1990">1990</option>
<option value="1989">1989</option>
<option value="1988">1988</option>
<option value="1987">1987</option>
<option value="1986">1986</option>
<option value="1985">1985</option>
<option value="1984">1984</option>
<option value="1983">1983</option>
<option value="1982">1982</option>
<option value="1981">1981</option>
<option value="1980">1980</option>
<option value="1979">1979</option>
<option value="1978">1978</option>
<option value="1977">1977</option>
<option value="1976">1976</option>
<option value="1975">1975</option>
<option value="1974">1974</option>
<option value="1973">1973</option>
<option value="1972">1972</option>
<option value="1971">1971</option>
<option value="1970">1970</option>
<option value="1969">1969</option>
<option value="1968">1968</option>
<option value="1967">1967</option>
<option value="1966">1966</option>
<option value="1965">1965</option>
<option value="1964">1964</option>
<option value="1963">1963</option>
<option value="1962">1962</option>
<option value="1961">1961</option>
<option value="1960">1960</option>
<option value="1959">1959</option>
<option value="1958">1958</option>
<option value="1957">1957</option>
<option value="1956">1956</option>
<option value="1955">1955</option>
<option value="1954">1954</option>
<option value="1953">1953</option>
<option value="1952">1952</option>
<option value="1951">1951</option>
<option value="1950">1950</option>
</select>
年
<select class="custom-select w-25" title="生年月日(月)" id="bday-month" autocomplete="bday-month">
<option selected="">--</option>
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
<option value="6">6</option>
<option value="7">7</option>
<option value="8">8</option>
<option value="9">9</option>
<option value="10">10</option>
<option value="11">11</option>
<option value="12">12</option>
</select>
月
<select class="custom-select w-25" title="生年月日(日)" id="bday-day" autocomplete="bday-day">
<option selected="">--</option>
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
<option value="6">6</option>
<option value="7">7</option>
<option value="8">8</option>
<option value="9">9</option>
<option value="10">10</option>
<option value="11">11</option>
<option value="12">12</option>
<option value="13">13</option>
<option value="14">14</option>
<option value="15">15</option>
<option value="16">16</option>
<option value="17">17</option>
<option value="18">18</option>
<option value="19">19</option>
<option value="20">20</option>
<option value="21">21</option>
<option value="22">22</option>
<option value="23">23</option>
<option value="24">24</option>
<option value="25">25</option>
<option value="26">26</option>
<option value="27">27</option>
<option value="28">28</option>
<option value="29">29</option>
<option value="30">30</option>
<option value="31">31</option>
</select>
日
</div>
​
</div>


<div class="form-row">
<label class="col-sm-3 col-form-label">性別</label>
<div class="col-sm-9">
 <select class="custom-select w-25" title="性別" id="sex" >
    <option value="0">女</option>
    <option value="1">男</option>
 </select>
</div>
</div>



<div class="form-row">
<label class="col-sm-3 col-form-label">GPS情報</label>
<div class="col-sm-9">
<select class="custom-select w-25" title="位置情報" id="GPS" >
   <option value="0">許可</option>
　　<option value="1">許可しない</option></select>
</div>
</div>




​
      <button type="button" class="btn btn-lg btn-block" id="fin_id">登録</button>
​


</div>


  <script>
firebase.auth().onAuthStateChanged( (user) => {
  if(!user) {
 window.location.replace("login.html");
   }
   let db = firebase.firestore(); // データベースに関する機能の取得
   const doc = db.collection("Users").doc(user.uid);
   doc.get().then(function(doc) {
    if (doc.exists) {
      const user_data = doc.data();
      document.getElementById( "name" ).value=user_data.name;
      checkSelect(document.getElementById("bday-year"),user_data.b_year);
      checkSelect(document.getElementById("bday-month"),user_data.b_month);
      checkSelect(document.getElementById("bday-day"),user_data.b_day);
      checkSelect(document.getElementById("sex"),user_data.gender);
      checkSelect(document.getElementById("GPS"),user_data.GPS);

      console.log("Document data:", doc.data());
    } else {
        // doc.data() will be undefined in this case
        console.log("No such document!");
    }
}).catch(function(error) {
    console.log("Error getting document:", error);
});
   });
// userを追加する
function add(){
  let userNameForAdd = $("#name").val(); // inputbox に入力された値を取得する
  let userGenderForAdd = $("#sex").val(); 
  let userBirthyearForAdd = $("#bday-year").val(); 
  let userBirthmonthForAdd = $("#bday-month").val(); 
  let userBirthdayForAdd = $("#bday-day").val(); 
  let userGPSForAdd = $("#GPS").val(); 

  var user = firebase.auth().currentUser;

  db.collection("Users").doc(user.uid).set({ // データベースにユーザーを追加する
      name:userNameForAdd, 
      //      uid:user.uid,
      gender:userGenderForAdd,
      b_year:userBirthyearForAdd,
      b_month:userBirthmonthForAdd,
      b_day:userBirthdayForAdd,
      GPS:userGPSForAdd,
      create_at: new Date() // 現在時刻
  }).then(function() { // 成功した場合に実行される箇所
//    history.back();
     window.location.replace("start.html");
  })
  .catch(function(error) { // 失敗した場合に実行される箇所
      console.error("Error adding document: ", error);
  });
}
</script>
<script>
const logout_btn = document.getElementById("logout");
const fin_id_btn = document.getElementById("fin_id");
let db = firebase.firestore(); // データベースに関する機能の取得

 firebase.auth().onAuthStateChanged( (user) => {
  if(!user) {
 window.location.replace("login.html");
   }
});

logout_btn.addEventListener("click", ()=>{
  firebase.auth().signOut().then(()=>{
    window.location.replace("login.html");
  })
  .catch( (error)=>{
    alert(`ログアウト時にエラーが発生しました (${error})`);
  });
});
   fin_id_btn.addEventListener("click", ()=>{add();});

function checkSelect(obj,val){
for(var i=0;i<obj.length;i++){
if(obj[i].value==val){
obj[i].selected=true;
break;
}
}
}

 </script>
</body>
</html>